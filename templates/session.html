<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Session - Maan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-activity-bar: #333333;
            --bg-sidebar: #252526;
            --bg-editor: #1e1e1e;
            --bg-status-bar: #007acc;
            --bg-tab-active: #1e1e1e;
            --bg-tab-inactive: #2d2d2d;
            --border-color: #454545;
            --text-primary: #cccccc;
            --text-secondary: #969696;
            --accent: #007acc;
            --hover-bg: #2a2d2e;
            --selection-bg: #37373d;
        }

        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
        
        body, html {
            height: 100vh;
            width: 100vw;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-editor);
            color: var(--text-primary);
            overflow: hidden;
            font-size: 13px;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
        }

        /* Title Bar */
        #title-bar {
            height: 35px;
            background-color: var(--bg-sidebar);
            display: flex;
            align-items: center;
            padding: 0 15px;
            border-bottom: 1px solid #000;
            color: var(--text-primary);
        }

        #title-bar .title-logo {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--accent);
        }

        #title-bar .title-logo i {
            font-size: 14px;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-sidebar);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 5px 0;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            min-width: 150px;
        }

        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .context-menu-item:hover {
            background: var(--hover-bg);
        }

        .context-menu-item i {
            width: 15px;
            text-align: center;
        }

        /* Activity Bar */
        #activity-bar {
            width: 50px;
            background-color: var(--bg-activity-bar);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
            z-index: 10;
        }

        .activity-item {
            width: 48px;
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 20px;
            border-left: 2px solid transparent;
            transition: color 0.2s;
        }

        .activity-item:hover { color: white; }
        .activity-item.active {
            color: white;
            border-left-color: white;
        }

        /* Sidebar */
        #sidebar {
            width: 260px;
            background-color: var(--bg-sidebar);
            display: flex;
            flex-direction: column;
            border-right: 1px solid #000;
        }

        .sidebar-header {
            padding: 10px 20px;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 35px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-top: 5px;
            max-height: calc(100vh - 57px); /* 35px header + 22px status bar */
        }

        .sidebar-content::-webkit-scrollbar {
            width: 10px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: var(--bg-sidebar);
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 5px;
        }

        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        /* File Tree */
        .tree-item {
            padding: 5px 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
        }

        .tree-item:hover { background-color: var(--hover-bg); }
        .file-icon { margin-right: 8px; color: #9cdcfe; }
        
        .user-dots {
            margin-left: auto;
            display: flex;
            gap: 3px;
        }
        
        .user-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 1px solid #333;
        }

        /* Main Area */
        #main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-editor);
            min-width: 0;
        }

        #tabs-bar {
            height: 35px;
            background-color: var(--bg-sidebar);
            display: flex;
            overflow-x: auto;
            border-bottom: 1px solid #000;
        }

        .tab {
            display: flex;
            align-items: center;
            padding: 0 10px;
            background-color: var(--bg-tab-inactive);
            color: var(--text-secondary);
            border-right: 1px solid #000;
            min-width: 120px;
            cursor: pointer;
            font-size: 13px;
        }

        .tab.active {
            background-color: var(--bg-tab-active);
            color: white;
            border-top: 1px solid var(--accent);
        }

        #editor-container {
            flex: 1;
            position: relative;
        }

        /* Right Chat Panel */
        #chat-panel {
            width: 300px;
            background-color: var(--bg-sidebar);
            border-left: 1px solid #000;
            display: flex;
            flex-direction: column;
            transition: width 0.3s;
        }

        #chat-panel.collapsed {
            width: 0;
            overflow: hidden;
        }

        .chat-header {
            padding: 10px 15px;
            border-bottom: 1px solid #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            background: var(--hover-bg);
        }

        .chat-sender {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 12px;
        }

        .chat-text {
            font-size: 13px;
            color: var(--text-primary);
        }

        .chat-input-container {
            padding: 10px;
            border-top: 1px solid #000;
        }

        .chat-input {
            width: 100%;
            padding: 8px;
            background: #3c3c3c;
            border: 1px solid var(--border-color);
            color: white;
            border-radius: 5px;
        }

        /* Users Panel */
        #users-panel {
            padding: 10px;
            display: none;
        }

        .user-item {
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--hover-bg);
        }

        .user-color-box {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }

        /* Status Bar */
        #status-bar {
            height: 22px;
            background-color: var(--bg-status-bar);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            font-size: 12px;
            z-index: 100;
        }

        /* Join Modal */
        .join-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .join-modal-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
        }

        .join-modal h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .join-modal input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .join-modal button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Approval Modal */
        .approval-modal {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-sidebar);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }

        .approval-modal.show {
            display: block;
        }

        .approval-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .approval-buttons button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-approve {
            background: #28a745;
            color: white;
        }

        .btn-reject {
            background: #dc3545;
            color: white;
        }

        .cursor-decoration {
            border-left: 2px solid;
            margin-left: -1px;
        }

        .cursor-line {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .cursor-line::before {
            content: '';
            position: absolute;
            width: 2px;
            height: 100%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }

        .cursor-label {
            position: absolute;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            pointer-events: none;
            z-index: 100;
        }

        .arrow {
            display: inline-block;
            width: 15px;
            font-size: 10px;
            color: var(--text-secondary);
            transition: transform 0.2s;
            margin-right: 5px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin: 0 3px;
            background: transparent;
            transition: all 0.2s;
        }

        .action-btn.danger {
            background: #fee;
            color: #c33;
        }

        .action-btn.danger:hover {
            background: #fcc;
        }

        .folder-children {
        }
    </style>
</head>
<body>

<!-- Join Modal -->
<div class="join-modal" id="join-modal">
    <div class="join-modal-content">
        <h2>Join Session</h2>
        <p style="color: #666; margin-bottom: 20px;">Enter your name to join the collaborative session</p>
        <input type="text" id="username-input" placeholder="Your Name" />
        <button onclick="joinSession()">Join</button>
    </div>
</div>

<!-- Approval Modal -->
<div class="approval-modal" id="approval-modal">
    <div style="color: var(--text-primary); margin-bottom: 10px; font-weight: 600;">Approval Request</div>
    <div id="approval-details" style="color: var(--text-secondary); font-size: 12px;"></div>
    <div class="approval-buttons">
        <button class="btn-approve" onclick="respondToApproval(true)">Approve</button>
        <button class="btn-reject" onclick="respondToApproval(false)">Reject</button>
    </div>
</div>

<div id="app">
    <!-- Title Bar -->
    <div id="title-bar">
        <div class="title-logo">
            <i class="fas fa-code-branch"></i>
            <span>Maan - معا</span>
        </div>
    </div>

    <div style="display: flex; flex: 1; overflow: hidden;">
        <!-- Activity Bar -->
        <div id="activity-bar">
            <div class="activity-item active" title="Explorer" id="explorer-btn" onclick="switchToExplorer()">
                <i class="far fa-copy"></i>
            </div>
            <div class="activity-item" title="Users" id="users-btn" onclick="switchToUsers()">
                <i class="fas fa-users"></i>
            </div>
            <div class="activity-item" title="Chat" id="chat-btn" onclick="toggleChat()">
                <i class="fas fa-comments"></i>
            </div>
            <div class="activity-item" style="margin-top: auto;" title="Leave Session" onclick="leaveSession()">
                <i class="fas fa-sign-out-alt"></i>
            </div>
        </div>

        <!-- Sidebar -->
        <div id="sidebar">
            <!-- Explorer -->
            <div id="explorer-pane">
                <div class="sidebar-header">
                    <span>EXPLORER</span>
                </div>
                <div class="sidebar-content" id="file-tree"></div>
            </div>

            <!-- Users Panel -->
            <div id="users-panel">
                <div class="sidebar-header">
                    <span>ACTIVE USERS</span>
                </div>
                <div class="sidebar-content" id="users-list"></div>
            </div>
        </div>

        <!-- Main Editor Area -->
        <div id="main-area">
            <div id="tabs-bar"></div>
            <div id="editor-container"></div>
            <div id="status-bar">
                <div style="display:flex;">
                    <div style="margin-right:15px;">Session: {{ session_id[:8] }}...</div>
                    <div id="users-count">Users: 0</div>
                </div>
                <div id="cursor-position">Ln 1, Col 1</div>
            </div>
        </div>

        <!-- Chat Panel -->
        <div id="chat-panel">
            <div class="chat-header">
                <span>CHAT</span>
                <i class="fas fa-times" onclick="toggleChat()" style="cursor:pointer;"></i>
            </div>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chat-input" placeholder="Type a message..." onkeydown="if(event.key === 'Enter') sendMessage()">
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.38.0/min/vs/loader.js"></script>

<script>
    const SESSION_ID = '{{ session_id }}';
    let socket;
    let editor;
    let currentUser = null;
    let userSessionId = null;
    let activeUsers = [];
    let openTabs = [];
    let activeTab = null;
    let currentApprovalId = null;
    let isAdmin = false;
    let cursorDecorations = {};
    let openFiles = {};
    let isReceivingRemoteChange = false;
    let documentVersion = 1;


    function init() {
        console.log('=== INIT DEBUG ===');
        console.log('localStorage.user:', localStorage.getItem('user'));
        console.log('All localStorage keys:', Object.keys(localStorage));
        console.log('sessionStorage.userSessionId:', sessionStorage.getItem('userSessionId'));
        console.log('==================');

        // Generate or retrieve unique session ID
        userSessionId = sessionStorage.getItem('userSessionId');
        if (!userSessionId) {
            userSessionId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            sessionStorage.setItem('userSessionId', userSessionId);
        }
        
        const userStr = localStorage.getItem('user');
        console.log('Checking user from localStorage:', userStr);
        
        if (userStr) {
            // Logged in user
            currentUser = JSON.parse(userStr);
            currentUser.sessionId = userSessionId;
            
            console.log('Found authenticated user:', currentUser);
            document.getElementById('join-modal').style.display = 'none';
            
            initSocket();
            initEditor();
            loadFiles();

            setTimeout(() => {
                setupEmptySpaceContextMenu();
            }, 500);
        } else {
            // Anonymous user - show modal
            console.log('No user found, showing join modal');
            document.getElementById('join-modal').style.display = 'flex';
        }
    }

    function joinSession() {
        const username = document.getElementById('username-input').value.trim();
        if (!username) {
            alert('Please enter your name');
            return;
        }
        
        currentUser = { 
            username, 
            is_anonymous: true,
            sessionId: userSessionId
        };
        
        localStorage.setItem('user', JSON.stringify(currentUser));
        
        const modal = document.getElementById('join-modal');
        modal.querySelector('h2').textContent = 'Waiting for Approval...';
        modal.querySelector('p').textContent = 'The admin is reviewing your request to join.';
        modal.querySelector('button').disabled = true;
        modal.querySelector('button').style.opacity = '0.5';
        modal.querySelector('input').disabled = true;
        
        initSocket();
    }

    function showJoinApprovalRequest(data) {
        const modal = document.getElementById('approval-modal');
        currentApprovalId = data.id;
        modal.dataset.approvalType = 'join';
        
        document.getElementById('approval-details').innerHTML = `
            <strong>${data.username}</strong> wants to join the session
        `;
        
        modal.classList.add('show');
    }

    function initSocket() {
        socket = io();

        // console.log('Emitting join_session with:', {
        //     session_id: SESSION_ID,
        //     username: currentUser.username,
        //     is_anonymous: currentUser.is_anonymous || false,
        //     sessionId: userSessionId
        // });
        
        socket.emit('join_session', {
            session_id: SESSION_ID,
            username: currentUser.username,
            is_anonymous: currentUser.is_anonymous || false,
            sessionId: userSessionId
        });

        socket.on('confirm_join', (data) => {
            // This is called after approval to actually join the room
            join_room(SESSION_ID);
        });

        // Receive own user data with color
        socket.on('user_connected', (data) => {
            currentUser.color = data.user.color;
            currentUser.sid = data.user.sid;
            isAdmin = data.user.is_admin || false;
            console.log('Connected with color:', currentUser.color);
        });

        socket.on('session_state', (data) => {
            activeUsers = data.users;
            updateUsersDisplay();
            updateFileUserDots();
        });

        socket.on('waiting_approval', (data) => {
            console.log('Waiting for admin approval');
            // Modal already shows waiting message
        });

        socket.on('join_approved', (data) => {
            currentUser.color = data.user.color;
            currentUser.sid = data.user.sid;
            isAdmin = data.user.is_admin || false;
            
            document.getElementById('join-modal').style.display = 'none';
            
            if (!editor) {
                initEditor();
            }
            loadFiles();

            setTimeout(() => {
                setupEmptySpaceContextMenu();
            }, 500);
            
            document.getElementById('chat-btn').classList.add('active');
        });


        socket.on('join_rejected', (data) => {
            alert(data.message);
            localStorage.removeItem('user');
            window.location.href = '/';
        });

        socket.on('join_approval_request', (data) => {
            if (isAdmin) {
                showJoinApprovalRequest(data);
            }
        });

        socket.on('user_joined', (data) => {
            activeUsers = data.users;
            updateUsersDisplay();
            updateFileUserDots();
            addChatMessage('System', '#silver', `${data.username} joined the session`);
        });

        socket.on('user_left', (data) => {
            activeUsers = activeUsers.filter(u => u.sid !== data.sid);
            updateUsersDisplay();
            updateFileUserDots();
            addChatMessage('System', '#silver', `${data.username} left the session`);
            
            // Remove from UI immediately
            const userItem = document.querySelector(`[data-sid="${data.sid}"]`);
            if (userItem) {
                userItem.remove();
            }
            
            // Remove cursor decorations
            if (cursorDecorations[data.sid]) {
                editor.deltaDecorations(cursorDecorations[data.sid], []);
                delete cursorDecorations[data.sid];
            }
            
            // Remove cursor style
            const style = document.getElementById(`cursor-style-${data.sid}`);
            if (style) style.remove();
        });

        socket.on('cursor_update', (data) => {
            if (activeTab && data.file === activeTab.path) {
                updateCursorDecoration(data.sid, data.position, data.color, data.username);
            }
        });

        socket.on('content_update', (data) => {
            if (activeTab && data.file === activeTab.path && editor && data.sid !== socket.id) {
                isReceivingRemoteChange = true;
                
                const edits = data.changes.map(change => ({
                    range: new monaco.Range(
                        change.range.startLineNumber,
                        change.range.startColumn,
                        change.range.endLineNumber,
                        change.range.endColumn
                    ),
                    text: change.text
                }));
                
                editor.executeEdits('remote-changes', edits);
                isReceivingRemoteChange = false;
            }
        });

        socket.on('user_file_change', (data) => {
            const user = activeUsers.find(u => u.sid === data.sid);
            if (user) {
                user.current_file = data.file;
                updateFileUserDots();
                updateUsersDisplay();
            }
        });

        socket.on('file_saved', (data) => {
            addChatMessage('System', '#28a745', `${data.user.username} saved ${data.path}`);

            if (openFiles[data.path]) {
                openFiles[data.path].content = data.content;
                openFiles[data.path].mtime = data.mtime;
                
                // If it's the active tab, update the model
                if (activeTab && activeTab.path === data.path) {
                    const currentPosition = editor.getPosition();
                    isReceivingRemoteChange = true;
                    editor.setValue(data.content);
                    editor.setPosition(currentPosition);
                    isReceivingRemoteChange = false;
                } else if (openFiles[data.path].model) {
                    // Update the model even if not active
                    openFiles[data.path].model.setValue(data.content);
                }
            }
        });

        socket.on('chat_message', (data) => {
            addChatMessage(data.username, data.color, data.message);
        });

        socket.on('approval_request', (data) => {
            if (isAdmin) {
                showApprovalRequest(data);
            }
        });

        socket.on('kicked', () => {
            alert('You have been removed from the session');
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = '/dashboard';
        });

        socket.on('session_closed', () => {
            alert('Session has been closed');
            window.location.href = '/dashboard';
        });

        socket.on('error', (data) => {
            alert(data.message);
        });
    }

    function initEditor() {
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.38.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: "// Open a file to start editing\n// Welcome to Maan collaborative session!",
                language: 'javascript',
                theme: 'vs-dark',
                automaticLayout: true,
                fontSize: 14,
                minimap: { enabled: true }
            });

            editor.onDidChangeModelContent((e) => {
                if (activeTab && socket && !isReceivingRemoteChange) {
                    // Send delta changes, not full content
                    socket.emit('file_change', {
                        session_id: SESSION_ID,
                        file: activeTab.path,
                        changes: e.changes,
                        version: documentVersion++
                    });
                }
            });

            editor.onDidChangeCursorPosition((e) => {
                document.getElementById('cursor-position').innerText = `Ln ${e.position.lineNumber}, Col ${e.position.column}`;
                if (activeTab && socket) {
                    socket.emit('cursor_move', {
                        session_id: SESSION_ID,
                        file: activeTab.path,
                        position: { line: e.position.lineNumber, column: e.position.column }
                    });
                }
            });

            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
                saveFile();
            });
        });
        document.getElementById('chat-btn').classList.add('active');
    }

    async function loadFiles() {
        const res = await fetch(`/api/session/${SESSION_ID}/files`);
        const data = await res.json();
        renderFileTree(data.children);
    }

    function updateFileUserDots() {
        // Clear all dots first
        document.querySelectorAll('.user-dots').forEach(dots => {
            dots.innerHTML = '';
        });
        
        // Add dots for each user's current file
        activeUsers.forEach(user => {
            if (user.current_file) {
                const dotsId = `dots-${user.current_file.replace(/[\\/\s.]/g, '-')}`;
                const dotsContainer = document.getElementById(dotsId);
                
                if (dotsContainer) {
                    const dot = document.createElement('div');
                    dot.className = 'user-dot';
                    dot.style.backgroundColor = user.color;
                    dot.title = user.username;
                    dotsContainer.appendChild(dot);
                }
            }
        });
    }

    function renderFileTree(items, container = null, level = 0, parentPath = '') {
        if (!container) container = document.getElementById('file-tree');
        if (level === 0) container.innerHTML = '';
        
        if (!items || items.length === 0) return;
        
        items.forEach(item => {
            const el = document.createElement('div');
            el.className = 'tree-item';
            el.style.paddingLeft = `${10 + level * 15}px`;
            
            const fullPath = parentPath ? `${parentPath}/${item.path}` : item.path;
            
            const icon = item.is_dir ? 'fa-folder' : 'fa-file';
            const arrow = item.is_dir ? '<span class="arrow">▶</span>' : '<span style="width:15px;display:inline-block;"></span>';
            const dotsId = `dots-${fullPath.replace(/[\\/\s.]/g, '-')}`;
            
            el.innerHTML = `
                ${arrow}
                <i class="file-icon fas ${icon}" style="margin-right:8px;"></i>
                <span>${item.name}</span>
                <div class="user-dots" id="${dotsId}"></div>
            `;
            
            el.setAttribute('data-path', fullPath);
            el.setAttribute('data-is-dir', item.is_dir);
            
            container.appendChild(el);
            
            if (item.is_dir) {
                const childContainer = document.createElement('div');
                childContainer.className = 'folder-children';
                childContainer.style.display = 'none';
                container.appendChild(childContainer);
                
                if (item.children && item.children.length > 0) {
                    renderFileTree(item.children, childContainer, level + 1, fullPath);
                }
                
                el.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const arrow = el.querySelector('.arrow');
                    
                    if (childContainer.style.display === 'none') {
                        childContainer.style.display = 'block';
                        arrow.textContent = '▼';
                        
                        if (!item.children || item.children.length === 0) {
                            try {
                                const res = await fetch(`/api/session/${SESSION_ID}/files?path=${encodeURIComponent(fullPath)}`);
                                const folderData = await res.json();
                                childContainer.innerHTML = '';
                                renderFileTree(folderData.children, childContainer, level + 1, fullPath);
                                updateFileUserDots();
                            } catch (err) {
                                console.error('Failed to load folder contents:', err);
                                childContainer.innerHTML = '<div style="padding: 5px 10px; color: #ff6b6b;">Failed to load</div>';
                            }
                        }
                    } else {
                        childContainer.style.display = 'none';
                        arrow.textContent = '▶';
                    }
                });
                
                // Context menu for folders (create, rename, delete)
                // if (isAdmin) {
                    el.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showContextMenu(e.clientX, e.clientY, fullPath, true);
                    });
                // }
            } else {
                // File click to open
                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openFile(fullPath, item.name);
                });
                
                // Context menu for files (rename, delete only)
                // if (isAdmin) {
                    el.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showContextMenu(e.clientX, e.clientY, fullPath, false);
                    });
                // }
            }
        });
        
        if (level === 0) {
            updateFileUserDots();
        }
    }

    function showContextMenu(x, y, path, isDir) {
        // Remove existing menu
        const existing = document.querySelector('.context-menu');
        if (existing) existing.remove();
        
        const menu = document.createElement('div');
        menu.className = 'context-menu';
        menu.style.left = `${x}px`;
        menu.style.top = `${y}px`;
        
        let options = [];
        
        if (isDir) {
            // Folder context menu: create inside this folder, rename, delete
            options = [
                { icon: 'fa-plus', text: 'New File', action: () => createFileInside(path, false) },
                { icon: 'fa-folder-plus', text: 'New Folder', action: () => createFileInside(path, true) },
                { icon: 'fa-edit', text: 'Rename', action: () => renameFile(path) },
                { icon: 'fa-trash', text: 'Delete', action: () => deleteFile(path) }
            ];
        } else {
            // File context menu: rename, delete only
            options = [
                { icon: 'fa-edit', text: 'Rename', action: () => renameFile(path) },
                { icon: 'fa-trash', text: 'Delete', action: () => deleteFile(path) }
            ];
        }
        
        options.forEach(opt => {
            const item = document.createElement('div');
            item.className = 'context-menu-item';
            item.innerHTML = `<i class="fas ${opt.icon}"></i>${opt.text}`;
            item.onclick = () => {
                opt.action();
                menu.remove();
            };
            menu.appendChild(item);
        });
        
        document.body.appendChild(menu);
        
        // Close on any click
        setTimeout(() => {
            const closeMenu = () => {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            };
            document.addEventListener('click', closeMenu);
        }, 10);
    }

    async function createFileInside(parentPath, isDir) {
        const name = prompt(`Enter ${isDir ? 'folder' : 'file'} name:`);
        if (!name) return;
        
        const path = `${parentPath}/${name}`;
        
        const res = await fetch(`/api/session/${SESSION_ID}/files/create`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ path, is_dir: isDir })
        });
        
        if (res.ok) {
            loadFiles();
        } else {
            const error = await res.json();
            alert(`Failed to create: ${error.error || 'Unknown error'}`);
        }
    }

    async function createFile(parentPath, isDir) {
        const name = prompt(`Enter ${isDir ? 'folder' : 'file'} name:`);
        if (!name) return;
        
        const path = name; // Root level creation
        
        const res = await fetch(`/api/session/${SESSION_ID}/files/create`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ path, is_dir: isDir })
        });
        
        if (res.ok) {
            loadFiles();
        } else {
            const error = await res.json();
            alert(`Failed to create: ${error.error || 'Unknown error'}`);
        }
    }

    async function renameFile(oldPath) {
        const newName = prompt('Enter new name:', oldPath.split('/').pop());
        if (!newName) return;
        
        const newPath = oldPath.split('/').slice(0, -1).concat(newName).join('/');
        
        const res = await fetch(`/api/session/${SESSION_ID}/files/rename`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ old_path: oldPath, new_path: newPath })
        });
        
        if (res.ok) {
            loadFiles();
        } else {
            alert('Failed to rename');
        }
    }

    async function deleteFile(path) {
        if (!confirm(`Delete ${path}?`)) return;
        
        const res = await fetch(`/api/session/${SESSION_ID}/files/delete?path=${encodeURIComponent(path)}`, {
            method: 'DELETE'
        });
        
        if (res.ok) {
            loadFiles();
        } else {
            alert('Failed to delete');
        }
    }

    async function openFile(path, name) {
        // Check if tab already exists
        let existingTab = openTabs.find(t => t.path === path);
        
        if (!existingTab) {
            // Fetch latest content from server
            const res = await fetch(`/api/session/${SESSION_ID}/files/content?path=${encodeURIComponent(path)}`);
            const data = await res.json();
            
            existingTab = { path, name, content: data.content, model: null };
            openTabs.push(existingTab);
            
            // Track in openFiles
            openFiles[path] = {
                content: data.content,
                mtime: data.mtime,
                model: null
            };
        } else {
            // Re-fetch to get latest content
            const res = await fetch(`/api/session/${SESSION_ID}/files/content?path=${encodeURIComponent(path)}`);
            const data = await res.json();
            
            // Update content if file was modified on disk
            if (!openFiles[path] || openFiles[path].mtime < data.mtime) {
                existingTab.content = data.content;
                if (openFiles[path]) {
                    openFiles[path].content = data.content;
                    openFiles[path].mtime = data.mtime;
                    if (openFiles[path].model) {
                        openFiles[path].model.setValue(data.content);
                    }
                }
            }
        }
        
        activeTab = existingTab;
        
        // Create or get Monaco model for this file
        if (!activeTab.model) {
            const language = getLanguageFromFilename(name);
            activeTab.model = monaco.editor.createModel(activeTab.content, language);
            if (openFiles[path]) {
                openFiles[path].model = activeTab.model;
            }
        }
        
        editor.setModel(activeTab.model);
        
        socket.emit('file_open', {
            session_id: SESSION_ID,
            file: path
        });
        
        renderTabs();
    }

    function renderTabs() {
        const container = document.getElementById('tabs-bar');
        container.innerHTML = openTabs.map((tab, idx) => `
            <div class="tab ${tab === activeTab ? 'active' : ''}" onclick="switchTab(${idx})">
                <i class="fas fa-file" style="margin-right:8px;"></i>
                ${tab.name}
                <i class="fas fa-times" onclick="closeTab(event, ${idx})" style="margin-left:8px;cursor:pointer;"></i>
            </div>
        `).join('');
    }

    function switchTab(index) {
        activeTab = openTabs[index];
        editor.setModel(activeTab.model);
        renderTabs();
        
        socket.emit('file_open', {
            session_id: SESSION_ID,
            file: activeTab.path
        });
    }

    function closeTab(event, index) {
        event.stopPropagation();
        
        const tab = openTabs[index];
        if (tab.model) tab.model.dispose();
        
        openTabs.splice(index, 1);
        
        if (activeTab === tab) {
            activeTab = openTabs.length > 0 ? openTabs[0] : null;
            if (activeTab) {
                editor.setModel(activeTab.model);
            } else {
                editor.setValue("// Open a file to start editing");
            }
        }
        
        renderTabs();
    }

    async function saveFile() {
        if (!activeTab) return;
        
        const res = await fetch(`/api/session/${SESSION_ID}/files/save`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                path: activeTab.path,
                content: editor.getValue(),
                user_info: currentUser
            })
        });
        
        const data = await res.json();
        if (data.status === 'pending_approval') {
            addChatMessage('System', 'orange', 'Save request sent to admin for approval');
        }
    }

    function sendMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        if (!message || !socket) return;
        
        socket.emit('chat_message', {
            session_id: SESSION_ID,
            username: currentUser.username,
            color: currentUser.color,
            message: message
        });
        
        input.value = '';
    }

    function addChatMessage(username, color, message) {
        const container = document.getElementById('chat-messages');
        const el = document.createElement('div');
        el.className = 'chat-message';
        el.innerHTML = `
            <div class="chat-sender" style="color: ${color}">${username}</div>
            <div class="chat-text">${message}</div>
        `;
        container.appendChild(el);
        container.scrollTop = container.scrollHeight;
    }

    function updateUsersDisplay() {
        document.getElementById('users-count').innerText = `Users: ${activeUsers.length}`;
        
        const container = document.getElementById('users-list');
        container.innerHTML = activeUsers.map(u => `
            <div class="user-item" data-sid="${u.sid}">
                <div class="user-color-box" style="background: ${u.color}"></div>
                <span style="flex:1;">${u.username}</span>
                ${u.current_file ? `<i class="fas fa-circle" style="font-size:6px; color:${u.color}; margin-right:8px;"></i>` : ''}
                ${isAdmin && u.sid !== socket.id ? `
                    <button class="action-btn danger" onclick="kickUser('${u.sid}')" style="padding:4px 8px;font-size:11px;">
                        <i class="fas fa-user-times"></i>
                    </button>
                ` : ''}
            </div>
        `).join('');
    }

    async function kickUser(sid) {
        if (!confirm('Kick this user?')) return;
        
        const res = await fetch(`/api/admin/kick-user/${SESSION_ID}/${sid}`, {
            method: 'POST'
        });
        
        if (!res.ok) {
            alert('Failed to kick user');
        }
    }

    function toggleChat() {
        const chatPanel = document.getElementById('chat-panel');
        const chatBtn = document.getElementById('chat-btn');
        
        chatPanel.classList.toggle('collapsed');
        
        if (chatPanel.classList.contains('collapsed')) {
            chatBtn.classList.remove('active');
        } else {
            chatBtn.classList.add('active');
        }
    }

    function toggleUsersPanel() {
        const explorer = document.getElementById('explorer-pane');
        const users = document.getElementById('users-panel');
        const explorerBtn = document.querySelector('[title="Explorer"]');
        const usersBtn = document.querySelector('[title="Users"]');
        
        if (users.style.display === 'block') {
            // Switch back to explorer
            explorer.style.display = 'block';
            users.style.display = 'none';
            explorerBtn.classList.add('active');
            usersBtn.classList.remove('active');
        } else {
            // Switch to users
            explorer.style.display = 'none';
            users.style.display = 'block';
            explorerBtn.classList.remove('active');
            usersBtn.classList.add('active');
        }
    }

    function showApprovalRequest(data) {
        const modal = document.getElementById('approval-modal');
        currentApprovalId = data.id;
        modal.dataset.approvalType = 'save';
        
        document.getElementById('approval-details').innerHTML = `
            <strong>${data.user.username}</strong> wants to save <strong>${data.path}</strong>
        `;
        
        modal.classList.add('show');
    }

    function respondToApproval(approved) {
        if (socket && currentApprovalId) {
            // Determine if this is a join or save approval
            // We'll add a data attribute to track this
            const modal = document.getElementById('approval-modal');
            const isJoinApproval = modal.dataset.approvalType === 'join';
            
            if (isJoinApproval) {
                socket.emit('join_approval_response', {
                    session_id: SESSION_ID,
                    approval_id: currentApprovalId,
                    approved: approved
                });
            } else {
                socket.emit('approval_response', {
                    session_id: SESSION_ID,
                    approval_id: currentApprovalId,
                    approved: approved
                });
            }
        }
        document.getElementById('approval-modal').classList.remove('show');
        delete document.getElementById('approval-modal').dataset.approvalType;
        currentApprovalId = null;
    }

    function updateCursorDecoration(sid, position, color, username) {
        if (!editor) return;
        
        // Find user if color/username not provided
        if (!color || !username) {
            const user = activeUsers.find(u => u.sid === sid);
            if (!user) return;
            color = user.color;
            username = user.username;
        }
        
        if (cursorDecorations[sid]) {
            editor.deltaDecorations(cursorDecorations[sid], []);
        }
        
        const decorations = [{
            range: new monaco.Range(
                position.line, 
                position.column, 
                position.line, 
                position.column
            ),
            options: {
                className: `cursor-line`,
                beforeContentClassName: `cursor-decoration-${sid}`,
                hoverMessage: { value: username },
                stickiness: monaco.editor.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges
            }
        }];
        
        cursorDecorations[sid] = editor.deltaDecorations([], decorations);
        
        // Update or create style for this cursor
        let style = document.getElementById(`cursor-style-${sid}`);
        if (!style) {
            style = document.createElement('style');
            style.id = `cursor-style-${sid}`;
            document.head.appendChild(style);
        }
        style.textContent = `
            .cursor-decoration-${sid} {
                border-left: 2px solid ${color} !important;
                position: absolute;
            }
            .cursor-decoration-${sid}::after {
                content: '${username}';
                position: absolute;
                top: -20px;
                left: 0;
                background: ${color};
                color: white;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 11px;
                white-space: nowrap;
                pointer-events: none;
                z-index: 1000;
            }
        `;
    }

    function getLanguageFromFilename(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const langMap = {
            'js': 'javascript', 'jsx': 'javascript',
            'ts': 'typescript', 'tsx': 'typescript',
            'py': 'python', 'java': 'java',
            'cpp': 'cpp', 'c': 'c', 'h': 'cpp',
            'cs': 'csharp', 'go': 'go',
            'rb': 'ruby', 'php': 'php',
            'html': 'html', 'css': 'css',
            'json': 'json', 'xml': 'xml',
            'md': 'markdown', 'sql': 'sql',
            'sh': 'shell', 'yaml': 'yaml', 'yml': 'yaml'
        };
        return langMap[ext] || 'plaintext';
    }

    function addCursorLabel(sid, user, position) {
        // Remove old label if exists
        const oldLabel = document.getElementById(`cursor-label-${sid}`);
        if (oldLabel) oldLabel.remove();
        
        // Create new label
        const label = document.createElement('div');
        label.id = `cursor-label-${sid}`;
        label.className = 'cursor-label';
        label.style.backgroundColor = user.color;
        label.textContent = user.username;
        
        // Position it at the cursor location
        const editorDom = editor.getDomNode();
        const coords = editor.getScrolledVisiblePosition(position);
        
        if (coords) {
            label.style.position = 'absolute';
            label.style.left = `${coords.left}px`;
            label.style.top = `${coords.top - 20}px`;
            editorDom.appendChild(label);
            
            // Remove after 3 seconds
            setTimeout(() => label.remove(), 3000);
        }
    }

    function leaveSession() {
        if (confirm('Are you sure you want to leave this session?')) {
            if (socket) {
                socket.emit('leave_session', { session_id: SESSION_ID });
            }
            window.location.href = '/dashboard';
        }
    }

    // Check if user is admin
    async function checkAdmin() {
        const res = await fetch(`/api/projects/${SESSION_ID}/info`);
        const data = await res.json();
        // You'd need to add admin check logic here
    }

    function switchToExplorer() {
        const explorer = document.getElementById('explorer-pane');
        const users = document.getElementById('users-panel');
        const explorerBtn = document.getElementById('explorer-btn');
        const usersBtn = document.getElementById('users-btn');
        
        explorer.style.display = 'block';
        users.style.display = 'none';
        explorerBtn.classList.add('active');
        usersBtn.classList.remove('active');
    }

    function switchToUsers() {
        const explorer = document.getElementById('explorer-pane');
        const users = document.getElementById('users-panel');
        const explorerBtn = document.getElementById('explorer-btn');
        const usersBtn = document.getElementById('users-btn');
        
        explorer.style.display = 'none';
        users.style.display = 'block';
        explorerBtn.classList.remove('active');
        usersBtn.classList.add('active');
    }

    function setupEmptySpaceContextMenu() {
        const fileTree = document.getElementById('file-tree');
        
        fileTree.addEventListener('contextmenu', (e) => {
            // if (!isAdmin) return;
            
            // Only show if clicking on the file-tree itself, not on items
            if (e.target === fileTree || e.target.classList.contains('sidebar-content')) {
                e.preventDefault();
                showRootContextMenu(e.clientX, e.clientY);
            }
        });
        
        // Also add to sidebar-content
        const sidebarContent = document.querySelector('#explorer-pane .sidebar-content');
        if (sidebarContent) {
            sidebarContent.addEventListener('contextmenu', (e) => {
                // if (!isAdmin) return;
                if (e.target === sidebarContent) {
                    e.preventDefault();
                    showRootContextMenu(e.clientX, e.clientY);
                }
            });
        }
    }

    // New function for root-level context menu
    function showRootContextMenu(x, y) {
        // Remove existing menu
        const existing = document.querySelector('.context-menu');
        if (existing) existing.remove();
        
        const menu = document.createElement('div');
        menu.className = 'context-menu';
        menu.style.left = `${x}px`;
        menu.style.top = `${y}px`;
        
        const options = [
            { icon: 'fa-plus', text: 'New File', action: () => createFile('', false) },
            { icon: 'fa-folder-plus', text: 'New Folder', action: () => createFile('', true) }
        ];
        
        options.forEach(opt => {
            const item = document.createElement('div');
            item.className = 'context-menu-item';
            item.innerHTML = `<i class="fas ${opt.icon}"></i>${opt.text}`;
            item.onclick = () => {
                opt.action();
                menu.remove();
            };
            menu.appendChild(item);
        });
        
        document.body.appendChild(menu);
        
        // Close on any click
        setTimeout(() => {
            const closeMenu = () => {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            };
            document.addEventListener('click', closeMenu);
        }, 10);
    }

    window.onload = init;
</script>

</body>
</html>